# Expense Deployer

Docker Compose orchestration for the Expense Tracker microservices architecture.

## Architecture

```
                     ┌─────────────────────────────────────┐
                     │        expense-deployer             │
                     │      (Docker Compose)               │
                     └─────────────────────────────────────┘
                                    │
      ┌─────────────────────────────┼─────────────────────────────┐
      │                             │                             │
      ▼                             ▼                             ▼
┌───────────────┐          ┌─────────────────┐          ┌─────────────────┐
│  expense-api  │──gRPC───▶│ expense-engine  │          │  Infrastructure │
│  (PHP 8.4)    │          │   (C++/gRPC)    │          │                 │
│  Laravel      │          │                 │          │  - PostgreSQL   │
└───────┬───────┘          └────────┬────────┘          │  - Redis        │
        │                           │                   └─────────────────┘
        └───────────────────────────┴───────────────────────────┘
                                    │
                                    ▼
                           ┌─────────────┐
                           │ PostgreSQL  │
                           │ (shared DB) │
                           └─────────────┘
```

## Prerequisites

- Docker 24.x+
- Docker Compose v2
- Git
- ~4GB RAM available
- Sibling repositories cloned:
  ```
  expense-tracker/
  ├── expense-api/        # PHP Laravel API
  ├── expense-engine/     # C++ gRPC service
  └── expense-deployer/   # This repository
  ```

## Quick Start

```bash
# 1. Clone all repositories (if not already done)
cd expense-tracker
git clone <expense-api-repo> expense-api
git clone <expense-engine-repo> expense-engine
git clone <expense-deployer-repo> expense-deployer

# 2. Run setup
cd expense-deployer
make setup

# 3. Edit .env with your database password (if prompted)
nano .env

# 4. Start services
make up

# 5. Check health
curl http://localhost:8000/health
```

## Services

| Service         | Port(s)      | Description                    |
|-----------------|--------------|--------------------------------|
| nginx           | 8000:80      | Reverse proxy for PHP API      |
| php             | (internal)   | PHP-FPM application server     |
| expense-engine  | 50051, 9090  | C++ gRPC service + metrics     |
| postgres        | 5432:5432    | PostgreSQL database            |
| redis           | 6379:6379    | Cache and queue backend        |
| queue-worker    | (internal)   | Laravel queue processor        |

## Common Commands

```bash
# Lifecycle
make up              # Start all services
make down            # Stop all services
make restart         # Restart all services
make status          # Show service status

# Logs
make logs            # All logs
make logs-php        # PHP & nginx logs
make logs-engine     # C++ engine logs
make logs-queue      # Queue worker logs

# Database
make migrate         # Run migrations
make db-cli          # PostgreSQL shell
make redis-cli       # Redis shell

# Development
make shell           # PHP container shell
make shell-engine    # Engine container shell
make test            # Run tests
make rebuild         # Force rebuild images
```

## Endpoints

| Endpoint | URL | Description |
|----------|-----|-------------|
| API Root | http://localhost:8000 | Service info |
| Health Check | http://localhost:8000/health | Service health |
| Metrics (PHP) | http://localhost:8000/metrics | Prometheus metrics |
| Metrics (C++) | http://localhost:9090/metrics | Engine metrics |
| API Docs | http://localhost:8000/api/documentation | Swagger UI |

## Configuration

### Environment Variables

Copy `.env.example` to `.env` and configure:

```bash
# Required - Must be set
APP_KEY=base64:...          # Laravel encryption key (auto-generated by setup)
DB_PASSWORD=...             # PostgreSQL password

# Optional - Have defaults
APP_ENV=local               # Environment (local/production)
APP_DEBUG=true              # Debug mode
LOG_LEVEL=debug             # Logging level
API_PORT=8000               # API port mapping
```

### Generate APP_KEY Manually

```bash
# Using openssl
echo "base64:$(openssl rand -base64 32)"

# Or using Laravel artisan (if PHP available locally)
cd ../expense-api && php artisan key:generate --show
```

## Development Workflow

### Hot Reload (PHP)

The `docker-compose.override.yml` mounts source code for live changes:

```bash
# Edit code in ../expense-api
# Changes reflect immediately (no rebuild needed)
```

### Rebuilding C++ Engine

```bash
# After changing C++ code:
docker compose build expense-engine
docker compose up -d expense-engine
```

### Running Migrations

```bash
# Standard migration
make migrate

# Fresh migration (drops all tables)
make migrate-fresh

# Rollback last migration
docker compose exec php php artisan migrate:rollback --step=1
```

### Running Tests

```bash
# All tests
make test

# PHP tests only
make test-php

# Specific test
docker compose exec php php artisan test --filter=HealthTest
```

## Troubleshooting

### Services won't start

```bash
# Check Docker resources
docker system df

# View detailed logs
docker compose logs --tail=100

# Rebuild from scratch
make clean
make setup
```

### Database connection errors

```bash
# Check postgres is healthy
docker compose ps postgres

# Test connection
docker compose exec postgres pg_isready -U expense_user

# View postgres logs
docker compose logs postgres
```

### gRPC connection issues

```bash
# Check engine is running
docker compose ps expense-engine

# Test gRPC port
nc -zv localhost 50051

# View engine logs
docker compose logs expense-engine
```

### PHP errors

```bash
# Check PHP logs
docker compose logs php

# Clear Laravel caches
docker compose exec php php artisan cache:clear
docker compose exec php php artisan config:clear

# Check permissions
docker compose exec php ls -la storage/
```

### Port conflicts

```bash
# Check what's using a port
lsof -i :8000
lsof -i :5432

# Change port in .env
API_PORT=8080
DB_PORT_EXTERNAL=5433
```

## File Structure

```
expense-deployer/
├── docker-compose.yml          # Main orchestration
├── docker-compose.override.yml # Development overrides
├── .env.example                # Environment template
├── .env                        # Local config (gitignored)
├── .gitignore
├── Makefile                    # Automation targets
├── README.md                   # This file
└── scripts/
    ├── setup.sh                # First-time setup
    ├── start.sh                # Start services
    ├── stop.sh                 # Stop services
    ├── logs.sh                 # View logs
    ├── migrate.sh              # Run migrations
    ├── test.sh                 # Run tests
    └── init-db.sql             # PostgreSQL init
```

## Production Considerations

1. **Secrets Management**: Use Docker secrets or external vault instead of .env
2. **SSL/TLS**: Add nginx SSL configuration or use a reverse proxy
3. **Logging**: Configure centralized logging (ELK, Loki, CloudWatch)
4. **Monitoring**: Set up Prometheus scraping and Grafana dashboards
5. **Backups**: Implement PostgreSQL backup strategy
6. **Scaling**: Consider container orchestration (Swarm, Kubernetes)

## License

MIT License
